<app-navbar></app-navbar>

@if (isLoading()) {
<div class="loading-container">
    <mat-spinner diameter="50"></mat-spinner>
    <p>Loading post...</p>
</div>
} @else if (errorConfig()) {
<app-error-state [config]="errorConfig()!" (retry)="onRetryLoadPost()">
</app-error-state>
} @else if (post()) {
<div class="post-details-container">

    <mat-card class="post-card">
        <mat-card-header class="post-header">
            <div class="header-container">
                <div class="header-info" (click)="navigateToProfile($event)">
                    <div class="user-pic">
                        @if (profilePic()) {
                        <img [src]="profilePic()" alt="profilepic" class="profile-pic">
                        } @else {
                        <div class="default-avatar">
                            <mat-icon>account_circle</mat-icon>
                        </div>
                        }
                    </div>

                    <div class="user-details">
                        <h3 class="full-name">{{ fullName() }}</h3>
                        <p class="username">@{{ post()?.creator?.username }}</p>
                    </div>
                </div>
            </div>
            <div class="header-container-right">
                <div class="post-stats">
                    <div class="stat-item like-item">
                        <button matIconButton (click)="onLikeToggle($event)" [disabled]="isLiking()" class="like-button"
                            aria-label="Like post">
                            <mat-icon [class.liked]="post()!.isLikedByCurrentUser">
                                {{ post()!.isLikedByCurrentUser ? 'favorite' : 'favorite_border' }}
                            </mat-icon>
                        </button>
                        <span>{{ post()!.likesCount }}</span>
                    </div>
                </div>
                @if (isOwnPost()) {
                <div class="post-menu">
                    <button matIconButton [matMenuTriggerFor]="menu" aria-label="Post options">
                        <mat-icon>more_vert</mat-icon>
                    </button>
                    <mat-menu #menu="matMenu">
                        <button mat-menu-item (click)="onEdit($event)">
                            <mat-icon>edit</mat-icon>
                            <span>Edit</span>
                        </button>
                        <button mat-menu-item (click)="onDelete($event)" class="delete-post">
                            <mat-icon>delete</mat-icon>
                            <span>Delete</span>
                        </button>
                    </mat-menu>
                </div>
                }
            </div>
        </mat-card-header>

        <mat-card-content>

            <!-- Title -->
            <h1 class="post-title">{{ post()!.title }}</h1>

            <!-- Content -->
            <div class="post-content">
                <div class="text-content">
                    <p>{{post()!.content}}</p>
                </div>

                <!-- Media Section -->
                @if (post()!.media && post()!.media.length > 0) {
                <mat-divider class="content-divider"></mat-divider>

                <!-- Media Preview Section -->
                <div class="media-preview">
                    <div class="media-grid">
                        @for (media of post()!.media; track $index) {
                        <div class="media-item" (click)="openMediaViewer(media.url, media.type)">
                            <!-- Image -->
                            @if (media.type === 'IMAGE') {
                            <img [src]="media.url" [alt]="'Post image ' + ($index + 1)" class="media-image" />
                            }

                            <!-- Video -->
                            @if (media.type === 'VIDEO'){
                            <video [src]="media.url" class="media-video"
                                (click)="$event.stopPropagation(); openMediaViewer(media.url, media.type)"></video>
                            }
                        </div>
                        }
                    </div>
                </div>
                }
            </div>

            <mat-divider></mat-divider>

            <div class="fotter">
                <div class="post-date">
                    <span>{{ formatDate(post()!.createdAt) }}</span>
                </div>
            </div>
        </mat-card-content>
    </mat-card>

    <!-- Comments Section -->
    @if (post()) {
    <div class="comments-section">
        <h2 class="comments-title">
            <mat-icon>comment</mat-icon>
            Comments ({{ post()!.commentsCount }})
        </h2>

        <!-- Comment Input (WhatsApp Style) -->
        <app-comment-input [postId]="postId!" [isLoading]="isSubmittingComment()"
            (commentSubmitted)="onCommentSubmit($event)"></app-comment-input>

        <mat-divider class="comments-divider"></mat-divider>

        <!-- Comment List -->
        <app-comment-list [comments]="comments()" [isLoading]="isLoadingComments()"
            [isLoadingMore]="isLoadingMoreComments()" [hasMore]="hasMoreComments()" [currentUserId]="getCurrentUserId()"
            (commentDeleted)="onCommentDelete($event)" (commentEdited)="onCommentEdit($event)"
            (loadMore)="loadMoreComments()">
        </app-comment-list>
    </div>
    }

    <!-- Media Viewer Modal -->
    @if (isMediaViewerOpen()) {
    <div class="media-viewer-overlay" (click)="closeMediaViewer()">
        <button class="close-button" mat-icon-button (click)="closeMediaViewer()" aria-label="Close media viewer">
            <mat-icon>close</mat-icon>
        </button>

        <div class="media-viewer-content" (click)="$event.stopPropagation()">
            @if (selectedMediaType() === 'IMAGE') {
            <img [src]="selectedMediaUrl()!" alt="Full size image" class="viewer-image" />
            }

            @if (selectedMediaType() === 'VIDEO') {
            <video [src]="selectedMediaUrl()!" class="viewer-video" controls autoplay></video>
            }
        </div>
    </div>
    }
</div>
}